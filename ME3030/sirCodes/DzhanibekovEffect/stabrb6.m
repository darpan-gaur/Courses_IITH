
function zdot=stabrb6(t,z)
global alpha beta a b c m gr

q=z(1:18);
qd=z(19:36);
f=m*gr*repmat([0 0 1]',6,1);

p1=z(1:3);   p2=z(4:6);
p3=z(7:9);   p4=z(10:12);
p5=z(13:15); p6=z(16:18);

v1=z(1+18:3+18);   v2=z(4+18:6+18);
v3=z(7+18:9+18);   v4=z(10+18:12+18);
v5=z(13+18:15+18); v6=z(16+18:18+18);

C12=sum((p1-p2).^2)-(a^2+b^2);
C23=sum((p2-p3).^2)-(a^2+b^2);
C34=sum((p3-p4).^2)-(a^2+b^2);
C41=sum((p4-p1).^2)-(a^2+b^2);

C51=sum((p5-p1).^2)-(a^2+c^2);
C52=sum((p5-p2).^2)-(c^2+b^2);
C53=sum((p5-p3).^2)-(a^2+c^2);
C54=sum((p5-p4).^2)-(c^2+b^2);

C61=sum((p6-p1).^2)-(a^2+c^2);
C62=sum((p6-p2).^2)-(c^2+b^2);
C63=sum((p6-p3).^2)-(a^2+c^2);
C64=sum((p6-p4).^2)-(c^2+b^2);


g=[C12 C23 C34 C41 C51 C52 C53 C54 C61 C62 C63 C64]';

J=zeros(12,18);
Jd=zeros(12,18);

%C12
J(1,1:3)=p1-p2;
J(1,4:6)=-(p1-p2);
Jd(1,1:3)=v1-v2;
Jd(1,4:6)=-(v1-v2);
%C23
J(2,4:6)=p2-p3;
J(2,7:9)=-(p2-p3);
Jd(2,4:6)=v2-v3;
Jd(2,7:9)=-(v2-v3);
%C34
J(3,7:9)=p3-p4;
J(3,10:12)=-(p3-p4);
Jd(3,7:9)=v3-v4;
Jd(3,10:12)=-(v3-v4);
%C41
J(4,1:3)=-(p4-p1);
J(4,10:12)=(p4-p1);
Jd(4,1:3)=-(v4-v1);
Jd(4,10:12)=(v4-v1);

%C51
J(5,1:3)=-(p5-p1);
J(5,13:15)=(p5-p1);
Jd(5,1:3)=-(v5-v1);
Jd(5,13:15)=(v5-v1);

%C52
J(6,4:6)=-(p5-p2);
J(6,13:15)=(p5-p2);
Jd(6,4:6)=-(v5-v2);
Jd(6,13:15)=(v5-v2);

%C53
J(7,7:9)=-(p5-p3);
J(7,13:15)=(p5-p3);
Jd(7,7:9)=-(v5-v3);
Jd(7,13:15)=(v5-v3);

%C54
J(8,10:12)=-(p5-p4);
J(8,13:15)=(p5-p4);
Jd(8,10:12)=-(v5-v4);
Jd(8,13:15)=(v5-v4);

%C61
J(9,1:3)=-(p6-p1);
J(9,16:18)=(p6-p1);
Jd(9,1:3)=-(v6-v1);
Jd(9,16:18)=(v6-v1);

%C62
J(10,4:6)=-(p6-p2);
J(10,16:18)=(p6-p2);
Jd(10,4:6)=-(v6-v2);
Jd(10,16:18)=(v6-v2);

%C63
J(11,7:9)=-(p6-p3);
J(11,16:18)=(p6-p3);
Jd(11,7:9)=-(v6-v3);
Jd(11,16:18)=(v6-v3);

%C64
J(12,10:12)=-(p6-p4);
J(12,16:18)=(p6-p4);
Jd(12,10:12)=-(v6-v4);
Jd(12,16:18)=(v6-v4);

gdot=J*qd;

M=diag(m*ones(18,1));
D=inv(J*inv(M)*J');
lam=D*(-Jd*qd-alpha*gdot-beta*g-J*inv(M)*f);
fc=J'*lam;
acc=inv(M)*(f+fc);
zdot=[qd; acc];
 

